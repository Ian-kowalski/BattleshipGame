batelship game (read al bevore ansering)
## context:=============================================================================================================
program.cs:-------------------------------------------------------------------------------------------------------------
using BattleshipGame.Data;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;

using SignalRChat.Hubs;

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.
var connectionString = builder.Configuration.GetConnectionString("DefaultConnection") ?? throw new InvalidOperationException("Connection string 'DefaultConnection' not found.");
builder.Services.AddDbContext<ApplicationDbContext>(options =>
    options.UseSqlServer(connectionString));
builder.Services.AddDatabaseDeveloperPageExceptionFilter();

builder.Services.AddDefaultIdentity<IdentityUser>(options => options.SignIn.RequireConfirmedAccount = true)
    .AddEntityFrameworkStores<ApplicationDbContext>();
builder.Services.AddControllersWithViews();

builder.Services.AddSignalR();

var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseMigrationsEndPoint();
}
else
{
    app.UseExceptionHandler("/Home/Error");
    // The default HSTS value is 30 days. You may want to change this for production scenarios, see https://aka.ms/aspnetcore-hsts.
    app.UseHsts();
}

app.UseHttpsRedirection();
app.UseStaticFiles();

app.UseRouting();

app.UseAuthorization();

app.MapControllerRoute(
    name: "default",
    pattern: "{controller=Home}/{action=Index}/{id?}");
app.MapRazorPages();

app.MapHub<GameHub>("/gameHub");

app.Run();

Views/Game/Game.cshtml:-------------------------------------------------------------------------------------------------
@model BattleshipGame.Models.GameBoardViewModel

<h2>Battleship Game</h2>

<game-board id="gameBoard"></game-board>

@section Scripts {
    <script src="~/js/signalr/dist/browser/signalr.js"></script>
    <script src="~/js/components/game-board.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const gameBoardElement = document.getElementById('gameBoard');
            const playerId = '@ViewBag.UserId'; // Use ViewBag to get the user ID
            const boardState = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(new
            {
                PlayerBoard = Model.PlayerBoard,
                TrackingBoard = Model.TrackingBoard,
                CurrentTurnPlayerId = Model.CurrentTurnPlayerId
            }));

            console.log('Player ID:', playerId);
            console.log('Board State:', boardState);

            gameBoardElement.setPlayerInfo(playerId);
            gameBoardElement.setBoardState(boardState);
        });
    </script>
}

Controlers/GameController.cs:-------------------------------------------------------------------------------------------
using Microsoft.AspNetCore.Mvc;
using BattleshipGame.Models;
using BattleshipGame.Data;
using Microsoft.AspNetCore.Identity;
using Newtonsoft.Json;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.SignalR;
using SignalRChat.Hubs;
using System.Threading.Tasks;

namespace BattleshipGame.Controllers
{
    //[Authorize]
    public class GameController : Controller
    {
        private readonly ApplicationDbContext _context;
        private readonly UserManager<IdentityUser> _userManager;
        private readonly IHubContext<GameHub> _hubContext;

        public GameController(ApplicationDbContext context, UserManager<IdentityUser> userManager, IHubContext<GameHub> hubContext)
        {
            _context = context;
            _userManager = userManager;
            _hubContext = hubContext;
        }

        public async Task<IActionResult> Game()
        {
            var userId = _userManager.GetUserId(User);
            var gameState = _context.GameStates.FirstOrDefault(g => g.PlayerId == userId);

            GameBoard playerBoard;
            GameBoard trackingBoard;
            string currentTurnPlayerId;

            if (gameState == null)
            {
                var allGameStates = _context.GameStates.ToList();
                if (allGameStates.Count >= 2)
                {
                    return BadRequest("The game is full. Only two players are allowed.");
                }

                playerBoard = new GameBoard();
                trackingBoard = new GameBoard();

                ShipGenerator.GenerateShips(playerBoard);

                gameState = new GameState
                {
                    PlayerId = userId,
                    PlayerBoard = JsonConvert.SerializeObject(playerBoard.Cells),
                    TrackingBoard = JsonConvert.SerializeObject(trackingBoard.Cells),
                };

                if (allGameStates.Count == 0)
                {
                    gameState.CurrentTurnPlayerId = userId; // First player to join gets the first turn
                }

                _context.GameStates.Add(gameState);
                await _context.SaveChangesAsync();

                await _hubContext.Clients.All.SendAsync("PlayerJoined", userId, allGameStates.Count + 1);
            }
            else
            {
                playerBoard = new GameBoard
                {
                    Cells = JsonConvert.DeserializeObject<CellState[,]>(gameState.PlayerBoard)
                };
                trackingBoard = new GameBoard
                {
                    Cells = JsonConvert.DeserializeObject<CellState[,]>(gameState.TrackingBoard)
                };
            }

            currentTurnPlayerId = gameState.CurrentTurnPlayerId;

            var viewModel = new GameBoardViewModel(playerBoard, trackingBoard, currentTurnPlayerId);
            ViewBag.UserId = userId; // Pass the user ID to the view using ViewBag
            return View(viewModel);
        }




        [HttpPost]
        public async Task<IActionResult> MakeMove(int x, int y)
        {
            var userId = _userManager.GetUserId(User);
            var gameState = _context.GameStates.FirstOrDefault(g => g.PlayerId == userId);

            if (gameState == null)
            {
                return BadRequest("Game state not found.");
            }

            var playerBoard = new GameBoard
            {
                Cells = JsonConvert.DeserializeObject<CellState[,]>(gameState.PlayerBoard)
            };
            var trackingBoard = new GameBoard
            {
                Cells = JsonConvert.DeserializeObject<CellState[,]>(gameState.TrackingBoard)
            };

            if (gameState.CurrentTurnPlayerId != userId)
            {
                return BadRequest("It's not your turn.");
            }

            var opponentGameState = _context.GameStates.FirstOrDefault(g => g.PlayerId != userId);
            if (opponentGameState == null)
            {
                return BadRequest("Opponent not found.");
            }

            var opponentBoard = new GameBoard
            {
                Cells = JsonConvert.DeserializeObject<CellState[,]>(opponentGameState.PlayerBoard)
            };

            var cellState = opponentBoard.Cells[x, y];
            bool hit = false;
            if (cellState == CellState.Ship)
            {
                opponentBoard.Cells[x, y] = CellState.Hit;
                hit = true;
            }
            else if (cellState == CellState.Empty)
            {
                opponentBoard.Cells[x, y] = CellState.Miss;
            }

            opponentGameState.PlayerBoard = JsonConvert.SerializeObject(opponentBoard.Cells);

            trackingBoard.Cells[x, y] = hit ? CellState.Hit : CellState.Miss;
            gameState.TrackingBoard = JsonConvert.SerializeObject(trackingBoard.Cells);

            gameState.CurrentTurnPlayerId = opponentGameState.PlayerId;

            _context.SaveChanges();

            await _hubContext.Clients.All.SendAsync("ReceiveMove", userId, x, y, hit);
            await _hubContext.Clients.User(opponentGameState.PlayerId).SendAsync("OpponentMove", x, y, hit);

            return Json(new { hit });
        }
    }
}

Data/ApplicationDbContext.cs:-------------------------------------------------------------------------------------------
using BattleshipGame.Models;
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;

namespace BattleshipGame.Data
{
    public class ApplicationDbContext : IdentityDbContext
    {
        public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)
            : base(options)
        {
        }
        public DbSet<GameState> GameStates { get; set; }
    }
}

wwwroot/js/components/game-board.js:------------------------------------------------------------------------------------
class GameBoard extends HTMLElement {
    constructor() {
        super();
        this.attachShadow({ mode: 'open' });
        this.render();
        this.setupSignalR();
        this.boardsInitialized = false;
        this.playerId = '';
    }

    render() {
        this.shadowRoot.innerHTML = `
            <link rel="stylesheet" href="/css/game-board.css">
            <div id="container">
                <div id="chat">
                    <div id="messages"></div>
                    <div id="chatInput">
                        <input type="text" id="messageInput" placeholder="Type a message...">
                        <button id="sendButton">Send</button>
                    </div>
                </div>
                <div id="boards">
                    <div id="yourBoard" class="board"></div>
                    <div id="trackingBoard" class="board"></div>
                </div>
            </div>
        `;

        this.initializeBoards();
        this.initializeChat();
    }

    setPlayerInfo(playerId) {
        console.log(`Setting player info: ${playerId}`);
        this.playerId = playerId;
    }

    initializeBoards() {
        if (this.boardsInitialized) return;

        console.log('Initializing boards');
        const yourBoard = this.shadowRoot.getElementById('yourBoard');
        const trackingBoard = this.shadowRoot.getElementById('trackingBoard');

        for (let i = 0; i < 100; i++) {
            const yourCell = document.createElement('div');
            yourCell.className = 'cell';
            yourBoard.appendChild(yourCell);

            const trackingCell = document.createElement('div');
            trackingCell.className = 'cell';
            trackingCell.classList.add('trackingCell');
            trackingBoard.appendChild(trackingCell);

            trackingCell.addEventListener('click', () => {
                const x = Math.floor(i / 10);
                const y = i % 10;
                this.makeMove(x, y);
            });
        }

        this.boardsInitialized = true;
    }

    initializeChat() {
        console.log('Initializing chat');
        const sendButton = this.shadowRoot.getElementById('sendButton');
        const messageInput = this.shadowRoot.getElementById('messageInput');

        sendButton.addEventListener('click', () => {
            const message = messageInput.value;
            if (message) {
                console.log(`Sending message: ${message}`);
                this.connection.invoke('SendMessage', this.playerId, message)
                    .catch(err => console.error(err));
                messageInput.value = '';
            }
        });
    }

    setBoardState(boardState) {
        console.log(`Setting board state:`, boardState);
        const yourBoard = this.shadowRoot.getElementById('yourBoard');
        const trackingBoard = this.shadowRoot.getElementById('trackingBoard');

        const { PlayerBoard, TrackingBoard, CurrentTurnPlayerId } = boardState;

        if (!PlayerBoard || !TrackingBoard) return;

        [...yourBoard.children].forEach((cell, index) => {
            const x = Math.floor(index / 10);
            const y = index % 10;
            const cellState = PlayerBoard[x][y];
            cell.className = 'cell';
            if (cellState === 1) cell.classList.add('ship');
            if (cellState === 2) cell.classList.add('hit');
            if (cellState === 3) cell.classList.add('miss');
        });

        [...trackingBoard.children].forEach((cell, index) => {
            const x = Math.floor(index / 10);
            const y = index % 10;
            const cellState = TrackingBoard[x][y];
            cell.className = 'cell trackingCell';
            if (cellState === 2) cell.classList.add('hit');
            if (cellState === 3) cell.classList.add('miss');
        });

        console.log(`Current Turn Player ID: ${CurrentTurnPlayerId}`);
    }

    setupSignalR() {
        console.log('Setting up SignalR');
        this.connection = new signalR.HubConnectionBuilder()
            .withUrl("/gameHub")
            .build();

        this.connection.start()
            .then(() => console.log('Connected to SignalR'))
            .catch(err => console.error(err));

        this.connection.on('ReceiveMessage', (user, message) => {
            const messagesDiv = this.shadowRoot.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.textContent = `${user}: ${message}`;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });

        this.connection.on('ReceiveMove', (user, x, y) => {
            console.log(`Received move: ${user} moved to (${x}, ${y})`);
            // Handle the move, update the board
        });

        this.connection.on('UpdateCurrentTurn', (currentTurnPlayerId) => {
            console.log(`Updated current turn player ID: ${currentTurnPlayerId}`);
            // Update the UI to show whose turn it is
            const turnIndicator = this.shadowRoot.getElementById('turnIndicator');
            if (currentTurnPlayerId === this.playerId) {
                turnIndicator.textContent = "It's your turn!";
            } else {
                turnIndicator.textContent = "Waiting for opponent's move...";
            }
        });


        this.connection.on('ReceiveGameState', (gameState) => {
            console.log(`Received game state:`, gameState);
            this.setBoardState(gameState);
        });

        this.connection.on('PlayerJoined', (userId, playerCount) => {
            console.log(`Player joined: ${userId} (Total: ${playerCount})`);
            // Handle new player joining, possibly refresh the game state
        });
    }

    makeMove(x, y) {
        console.log(`Making move at (${x}, ${y})`);
        this.connection.invoke('SendMove', this.playerId, x, y)
            .catch(err => console.error(err));
    }
}

customElements.define('game-board', GameBoard);

wwwroot/css/game-board.css:---------------------------------------------------------------------------------------------
#container {
    display: flex;
    flex-direction: column;
    align-items: center;
}

#chat {
    width: 100%;
    max-width: 600px;
    margin-bottom: 20px;
}

#messages {
    border: 1px solid #ccc;
    height: 200px;
    overflow-y: auto;
    padding: 10px;
    background-color: #f9f9f9;
}

#chatInput {
    display: flex;
    margin-top: 10px;
}

#messageInput {
    flex-grow: 1;
    padding: 5px;
}

#sendButton {
    padding: 5px 10px;
}

#boards {
    display: flex;
    justify-content: space-around;
    width: 100%;
}

.board {
    display: grid;
    grid-template-columns: repeat(10, 30px);
    grid-template-rows: repeat(10, 30px);
    gap: 2px;
}

.cell {
    width: 30px;
    height: 30px;
    border: 1px solid #000;
    background-color: #fff;
    position: relative;
}

#trackingBoard .cell:hover {
    background-color: lightblue;
}

.ship {
    background-color: lightslategray;
}

.hit {
    background-color: red;
}

.miss {
    background-color: lightgray;
}


models/GameState.cs:----------------------------------------------------------------------------------------------------
namespace BattleshipGame.Models
{
    public class GameState
    {
        public int Id { get; set; }
        public string PlayerId { get; set; }
        public string PlayerBoard { get; set; } // JSON representation of the player's game board
        public string TrackingBoard { get; set; } // JSON representation of the tracking board
        public string CurrentTurnPlayerId { get; set; }

    }
}

models/GameBoard.cs:----------------------------------------------------------------------------------------------------
namespace BattleshipGame.Models
{
    public class GameBoard
    {
        public const int BoardSize = 10;
        public CellState[,] Cells { get; set; }


        public GameBoard()
        {
            Cells = new CellState[BoardSize, BoardSize];
            for (int i = 0; i < BoardSize; i++)
            {
                for (int j = 0; j < BoardSize; j++)
                {
                    Cells[i, j] = CellState.Empty;
                }
            }
        }

        public bool IsHit(int x, int y)
        {
            if (Cells[x, y] == CellState.Ship)
            {
                Cells[x, y] = CellState.Hit;
                return true;
            }

            Cells[x, y] = CellState.Miss;
            return false;
        }
    }

    public enum CellState
    {
        Empty,
        Ship,
        Hit,
        Miss
    }
}

models/GameBoardViewModel.cs:-------------------------------------------------------------------------------------------
namespace BattleshipGame.Models;

public class GameBoardViewModel
{
    public int BoardSize { get; set; }
    public CellState[,] PlayerBoard { get; set; }
    public CellState[,] TrackingBoard { get; set; }
    public string CurrentTurnPlayerId { get; set; }

    public GameBoardViewModel(GameBoard playerBoard, GameBoard trackingBoard, string currentTurnPlayerId)
    {
        BoardSize = GameBoard.BoardSize;
        PlayerBoard = playerBoard.Cells;
        TrackingBoard = trackingBoard.Cells;
        CurrentTurnPlayerId = currentTurnPlayerId;
    }

    public GameBoardViewModel()
    {
        BoardSize = GameBoard.BoardSize;
        PlayerBoard = new CellState[BoardSize, BoardSize];
        TrackingBoard = new CellState[BoardSize, BoardSize];
    }
}

models/Ship.cs:---------------------------------------------------------------------------------------------------------
namespace BattleshipGame.Models
{
    public class Ship
    {
        public int Size { get; set; }
        public bool IsVertical { get; set; }
        public int X { get; set; }
        public int Y { get; set; }
    }
}

models/ShipGenerator.cs:------------------------------------------------------------------------------------------------
using System;
using System.Collections.Generic;

namespace BattleshipGame.Models
{
    public static class ShipGenerator
    {
        private static readonly List<int> ShipSizes = new List<int> { 5, 4, 3, 3, 2 };
        private static Random random = new Random();

        private static bool CanPlaceShip(GameBoard board, int size, bool isVertical, int x, int y)
        {
            if (isVertical)
            {
                if (x + size > GameBoard.BoardSize) return false;
                for (int i = 0; i < size; i++)
                {
                    if (board.Cells[x + i, y] != CellState.Empty) return false;
                }
            }
            else
            {
                if (y + size > GameBoard.BoardSize) return false;
                for (int i = 0; i < size; i++)
                {
                    if (board.Cells[x, y + i] != CellState.Empty) return false;
                }
            }
            return true;
        }

        private static void PlaceShip(GameBoard board, int size, bool isVertical, int x, int y)
        {
            if (isVertical)
            {
                for (int i = 0; i < size; i++)
                {
                    board.Cells[x + i, y] = CellState.Ship;
                }
            }
            else
            {
                for (int i = 0; i < size; i++)
                {
                    board.Cells[x, y + i] = CellState.Ship;
                }
            }
        }

        public static void GenerateShips(GameBoard board)
        {
            foreach (int size in ShipSizes)
            {
                bool placed = false;
                while (!placed)
                {
                    bool isVertical = random.Next(2) == 0;
                    int x = random.Next(GameBoard.BoardSize);
                    int y = random.Next(GameBoard.BoardSize);

                    if (CanPlaceShip(board, size, isVertical, x, y))
                    {
                        PlaceShip(board, size, isVertical, x, y);
                        placed = true;
                    }
                }
            }
        }
    }
}

hubs/gameHub.cs:--------------------------------------------------------------------------------------------------------
using BattleshipGame.Models;
using Microsoft.AspNetCore.SignalR;
using System.Collections.Concurrent;
using System.Linq;
using System.Threading.Tasks;

namespace SignalRChat.Hubs
{
    public class GameHub : Hub
    {
        private static readonly ConcurrentDictionary<string, string> Users = new ConcurrentDictionary<string, string>();
        private static readonly ConcurrentQueue<string> PlayerQueue = new ConcurrentQueue<string>(new[] { "Player 1", "Player 2" });
        private static string CurrentTurnPlayerId;

        public override async Task OnConnectedAsync()
        {
            if (Users.Count >= 2)
            {
                await Clients.Caller.SendAsync("ReceiveMessage", "System", "Game room is full.");
                Context.Abort();
            }
            else
            {
                if (PlayerQueue.TryDequeue(out var player))
                {
                    Users[Context.ConnectionId] = player;
                    await Clients.Caller.SendAsync("ReceiveMessage", "System", $"Welcome {player}!");

                    if (Users.Count == 1)
                    {
                        CurrentTurnPlayerId = Context.ConnectionId; // First player to join gets the first turn
                    }

                    await Clients.All.SendAsync("UpdatePlayers", Users.Values);
                    await Clients.All.SendAsync("UpdateCurrentTurn", CurrentTurnPlayerId);
                }
                await base.OnConnectedAsync();
            }
        }

        public override async Task OnDisconnectedAsync(Exception exception)
        {
            if (Users.TryRemove(Context.ConnectionId, out var player))
            {
                PlayerQueue.Enqueue(player);
                await Clients.All.SendAsync("ReceiveMessage", "System", $"{player} has left the game.");
                await Clients.All.SendAsync("UpdatePlayers", Users.Values);
            }

            if (Context.ConnectionId == CurrentTurnPlayerId)
            {
                CurrentTurnPlayerId = Users.Keys.FirstOrDefault(); // Assign turn to another player if the current turn player disconnects
                await Clients.All.SendAsync("UpdateCurrentTurn", CurrentTurnPlayerId);
            }

            await base.OnDisconnectedAsync(exception);
        }

        public async Task SendGameState(string userId, GameState gameState)
        {
            Console.WriteLine($"Sending game state to user {userId}");
            await Clients.User(userId).SendAsync("ReceiveGameState", gameState);
        }

        public async Task SendMessage(string user, string message)
        {
            await Clients.All.SendAsync("ReceiveMessage", user, message);
        }

        public async Task SendMove(string user, int x, int y)
        {
            if (Context.ConnectionId != CurrentTurnPlayerId)
            {
                await Clients.Caller.SendAsync("ReceiveMessage", "System", "It's not your turn.");
                return;
            }

            await Clients.All.SendAsync("ReceiveMove", user, x, y);
            CurrentTurnPlayerId = Users.Keys.FirstOrDefault(id => id != Context.ConnectionId);
            await Clients.All.SendAsync("UpdateCurrentTurn", CurrentTurnPlayerId);
        }
    }
}


Qeustion:==================================================================================================================
i cun run the progrgrm from the same acout and diffrent tabs fine but when i try to join vrom a secon acount i get "Cannot insert the value NULL into column 'CurrentTurnPlayerId', table 'aspnet-BattleshipGame-b814533c-2ce0-441f-8b44-a546180e610d.dbo.GameStates'; column does not allow nulls.". i think this has to do with tat it handels curnt player two diffrends ways 1.database(whre it brakes) and 2.in the hub i think these shoud be sicnkt up if atal posible. and if at al posible i woud like the username to be that wich the user loged in with